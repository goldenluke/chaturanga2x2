<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Chaturanga 16x16 - Team Chat Edition</title>
    <style>
        :root {
            --bg: #020617; --card: #1e293b;
            --tile-l: #cbd5e1; --tile-d: #475569;
            --c0: #f87171; --c1: #4ade80; --c2: #fbbf24; --c3: #60a5fa;
        }
        * { box-sizing: border-box; touch-action: manipulation; }
        body { font-family: 'Inter', sans-serif; background: var(--bg); color: white; margin: 0; padding: 10px; display: flex; flex-direction: column; align-items: center; }

        /* Overlay de Sele√ß√£o de Jogador */
        #player-selector {
            position: fixed; top:0; left:0; width:100%; height:100%; background: rgba(0,0,0,0.9);
            z-index: 1000; display: flex; flex-direction: column; align-items: center; justify-content: center;
        }
        .sel-btn { width: 200px; padding: 15px; margin: 10px; border: none; border-radius: 8px; font-weight: bold; cursor: pointer; color: white; }

        /* Barra de Score */
        .score-ui { width: 100%; max-width: 600px; margin-bottom: 10px; }
        .score-bar { height: 12px; background: #1e293b; border-radius: 6px; overflow: hidden; display: flex; border: 1px solid #334155; }
        #bar-a { background: var(--c0); width: 50%; transition: 0.8s ease; }
        #bar-b { background: var(--c1); width: 50%; transition: 0.8s ease; }

        #board { 
            display: grid; 
            grid-template-columns: repeat(16, var(--cell-size)); 
            grid-template-rows: repeat(16, var(--cell-size)); 
            background: #0f172a; border: 4px solid #334155;
            --cell-size: 5.6vw;
        }
        @media (min-width: 900px) { #board { --cell-size: 40px; } }

        .cell { width: var(--cell-size); height: var(--cell-size); display: flex; justify-content: center; align-items: center; font-size: calc(var(--cell-size) * 0.7); cursor: pointer; }
        .l { background: var(--tile-l); } .d { background: var(--tile-d); }
        .void { visibility: hidden; pointer-events: none; }
        
        .piece { z-index: 10; user-select: none; }
        .p0 .piece { color: var(--c0); text-shadow: 0 0 10px var(--c0); }
        .p1 .piece { color: var(--c1); text-shadow: 0 0 10px var(--c1); }
        .p2 .piece { color: var(--c2); text-shadow: 0 0 10px var(--c2); }
        .p3 .piece { color: var(--c3); text-shadow: 0 0 10px var(--c3); }

        .selected { background: #94a3b8 !important; }
        .hint { background: rgba(74, 222, 128, 0.3) !important; border-radius: 50%; background-clip: content-box; padding: 10px; }
        .hint-cap { background: rgba(248, 113, 113, 0.4) !important; }

        /* Container do Chat */
        #chat-container {
            width: 100%; max-width: 600px; background: var(--card); border-radius: 8px; margin-top: 15px;
            display: flex; flex-direction: column; border: 1px solid #334155;
        }
        #chat-messages { height: 100px; overflow-y: auto; padding: 10px; font-size: 12px; border-bottom: 1px solid #334155; }
        .msg { margin-bottom: 5px; }
        .msg-name { font-weight: bold; margin-right: 5px; }
        #chat-input-area { display: flex; padding: 5px; }
        #chat-input { flex: 1; background: #000; border: 1px solid #334155; color: white; padding: 8px; border-radius: 4px; }
        #chat-send { background: #3b82f6; border: none; color: white; padding: 0 15px; margin-left: 5px; border-radius: 4px; }

        #ui { width: 100%; max-width: 600px; margin-top: 10px; display: flex; flex-direction: column; gap: 8px; }
        .players-grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 6px; }
        .stat-card { background: var(--card); padding: 8px; border-radius: 6px; border-left: 5px solid #444; font-size: 11px; }
        .active-p { border-left-color: #fff !important; background: #334155; }
        
        #log { background: #000; height: 50px; overflow-y: auto; padding: 5px; font-family: monospace; font-size: 10px; color: #4ade80; }
        button { background: #334155; color: white; border: 1px solid #475569; padding: 10px; border-radius: 6px; cursor: pointer; font-weight: bold; }
    </style>
</head>
<body>

    <div id="player-selector">
        <h2>Quem √© voc√™ na mesa?</h2>
        <button class="sel-btn" style="background:var(--c0)" onclick="setMyRole(0)">Jogador 1 (Vermelho)</button>
        <button class="sel-btn" style="background:var(--c1)" onclick="setMyRole(1)">Jogador 2 (Verde)</button>
        <button class="sel-btn" style="background:var(--c2)" onclick="setMyRole(2)">Jogador 3 (Amarelo)</button>
        <button class="sel-btn" style="background:var(--c3)" onclick="setMyRole(3)">Jogador 4 (Azul)</button>
        <p style="font-size: 11px; color: #666; margin-top: 20px;">Cada equipe tem um chat privado exclusivo.</p>
    </div>

    <div class="score-ui">
        <div style="display:flex; justify-content:space-between; font-size:11px; font-weight:bold; margin-bottom:4px;">
            <span style="color:var(--c0)">TIME A (Chat Privado)</span>
            <span style="color:var(--c1)">TIME B (Chat Privado)</span>
        </div>
        <div class="score-bar"><div id="bar-a"></div><div id="bar-b"></div></div>
    </div>

    <div id="board"></div>

    <div id="chat-container">
        <div id="chat-messages"></div>
        <div id="chat-input-area">
            <input type="text" id="chat-input" placeholder="Conversar com seu parceiro...">
            <button id="chat-send" onclick="sendChatMessage()">Enviar</button>
        </div>
    </div>

    <div id="ui">
        <div class="players-grid">
            <div id="p0-card" class="stat-card">P1: Vermelho (A)</div>
            <div id="p1-card" class="stat-card">P2: Leste (B)</div>
            <div id="p2-card" class="stat-card">P3: Sul (A)</div>
            <div id="p3-card" class="stat-card">P4: Oeste (B)</div>
        </div>
        <button onclick="engine.aiMove()">Sugest√£o da IA</button>
        <div id="log">Aguardando...</div>
        <button onclick="resetOnlineGame()" style="background:#450a0a; border:none; padding:5px; font-size:10px;">Resetar Partida</button>
    </div>

<script src="https://www.gstatic.com/firebasejs/9.1.3/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.1.3/firebase-database-compat.js"></script>

<script>
/** FIREBASE CONFIG **/
const firebaseConfig = {
    apiKey: "AIzaSyCWE88_PnPfL6QPa9-R9zN6QPQ5Y8Ni_E0",
    authDomain: "chess-4x4.firebaseapp.com",
    databaseURL: "https://chess-4x4-default-rtdb.firebaseio.com",
    projectId: "chess-4x4",
    storageBucket: "chess-4x4.firebasestorage.app",
    messagingSenderId: "735568669929",
    appId: "1:735568669929:web:b5faa11547954fb8051478"
};
firebase.initializeApp(firebaseConfig);
const db = firebase.database().ref("team_chat_citadel_v1");

/** ESTADO DO JOGADOR LOCAL **/
let MY_PLAYER_ID = null;
let MY_TEAM = null;

function setMyRole(id) {
    MY_PLAYER_ID = id;
    MY_TEAM = (id === 0 || id === 2) ? 'teamA' : 'teamB';
    document.getElementById('player-selector').style.display = 'none';
    log(`Voc√™ entrou como Jogador ${id+1}.`);
    initChatListener();
}

/** CHAT LOGIC **/
function sendChatMessage() {
    const input = document.getElementById('chat-input');
    const text = input.value.trim();
    if (text === "" || MY_TEAM === null) return;

    const chatRef = db.child('chats').child(MY_TEAM);
    chatRef.push({
        player: MY_PLAYER_ID,
        msg: text,
        timestamp: Date.now()
    });
    input.value = "";
}

function initChatListener() {
    const chatRef = db.child('chats').child(MY_TEAM);
    // Limpar chat local antes de carregar
    document.getElementById('chat-messages').innerHTML = `<div style="color:#666; font-style:italic">Chat privado do Time ${MY_TEAM === 'teamA' ? 'A' : 'B'} conectado.</div>`;
    
    chatRef.limitToLast(15).on('child_added', (snap) => {
        const data = snap.val();
        const msgList = document.getElementById('chat-messages');
        const div = document.createElement('div');
        div.className = 'msg';
        const color = ['#f87171','#4ade80','#fbbf24','#60a5fa'][data.player];
        div.innerHTML = `<span class="msg-name" style="color:${color}">P${data.player+1}:</span><span>${data.msg}</span>`;
        msgList.appendChild(div);
        msgList.scrollTop = msgList.scrollHeight;
    });
}

// Enviar com a tecla Enter
document.getElementById('chat-input').addEventListener('keypress', function (e) {
    if (e.key === 'Enter') sendChatMessage();
});

/** ENGINE LOGIC (MANTIDA) **/
const PIECE_ICONS = { 'R':'‚ôú', 'N':'‚ôû', 'E':'üêò', 'F':'ü¶Ö', 'D':'üêâ', 'X':'üî•', 'G':'‚öîÔ∏è', 'K':'‚ôö', 'P':'‚ôü' };
const PIECE_VALS = { 'P':10, 'N':30, 'E':25, 'F':35, 'D':55, 'X':40, 'G':65, 'R':50, 'K':1000 };

class ChaturangaEngine {
    constructor() {
        this.dim = 16;
        this.board = [];
        this.turn = 0;
        this.kingsAlive = [true, true, true, true];
    }

    createBoard() {
        let b = [];
        for (let r = 0; r < 16; r++) {
            b[r] = [];
            for (let c = 0; c < 16; c++) {
                const isVoid = (r < 3 || r > 12) && (c < 3 || c > 10); // Ajuste leve para manter os 10 de largura
                b[r][c] = { type: null, player: null, void: (r < 3 || r > 12) && (c < 3 || c > 12), firstMove: true };
            }
        }
        const layout = ['R','N','E','F','K','G','D','X','N','R'];
        for(let i=0; i<10; i++) {
            this.setPiece(b, 0, i+3, layout[i], 0); this.setPiece(b, 1, i+3, 'P', 0);
            this.setPiece(b, 15, i+3, layout[9-i], 2); this.setPiece(b, 14, i+3, 'P', 2);
            this.setPiece(b, i+3, 15, layout[i], 1); this.setPiece(b, i+3, 14, 'P', 1);
            this.setPiece(b, i+3, 0, layout[9-i], 3); this.setPiece(b, i+3, 1, 'P', 3);
        }
        return b;
    }

    setPiece(b, r, c, t, p) { if(t) b[r][c] = { type: t, player: p, void: false, firstMove: true }; }

    getMoves(r, c, b) {
        const p = b[r][c];
        if(!p || !p.type) return [];
        let m = [];
        const ds = {
            ortho: [[0,1],[0,-1],[1,0],[-1,0]],
            diag: [[1,1],[1,-1],[-1,1],[-1,-1]],
            knight: [[1,2],[1,-2],[-1,2],[-1,-2],[2,1],[2,-1],[-2,1],[-2,-1]],
            jump2Diag: [[2,2],[2,-2],[-2,2],[-2,-2]]
        };
        const slide = (dirs, limit) => dirs.forEach(d => {
            for(let i=1; i<=limit; i++) {
                let nr = r+d[0]*i, nc = c+d[1]*i;
                if(!this.isOk(nr, nc)) break;
                if(!b[nr][nc].type) { m.push({r: nr, c: nc}); } else {
                    if(b[nr][nc].player%2 !== p.player%2) m.push({r: nr, c: nc});
                    break;
                }
            }
        });
        const jump = (dirs) => dirs.forEach(d => {
            let nr = r+d[0], nc = c+d[1];
            if(this.isOk(nr, nc) && (!b[nr][nc].type || b[nr][nc].player%2 !== p.player%2)) m.push({r: nr, c: nc});
        });

        if(p.type==='R') slide(ds.ortho, 16);
        if(p.type==='N') jump(ds.knight);
        if(p.type==='E') jump(ds.jump2Diag);
        if(p.type==='F') slide(ds.diag, 4);
        if(p.type==='T') slide(ds.ortho, 2);
        if(p.type==='X') slide(ds.diag, 2);
        if(p.type==='G') slide([...ds.ortho, ...ds.diag], 2);
        if(p.type==='D') { jump(ds.knight); slide(ds.ortho, 2); }
        if(p.type==='K') jump([...ds.ortho, ...ds.diag]);
        if(p.type==='P') {
            let f = [[1,0], [0,-1], [-1,0], [0,1]][p.player];
            if(this.isOk(r+f[0], c+f[1]) && !b[r+f[0]][c+f[1]].type) {
                m.push({r: r+f[0], c: c+f[1]});
                if(p.firstMove && this.isOk(r+f[0]*2, c+f[1]*2) && !b[r+f[0]*2][c+f[1]*2].type) m.push({r: r+f[0]*2, c: c+f[1]*2});
            }
            let caps = p.player%2===0 ? [[f[0],1], [f[0],-1]] : [[1,f[1]], [-1,f[1]]];
            caps.forEach(s => {
                let nr = r+s[0], nc = c+s[1];
                if(this.isOk(nr, nc) && b[nr][nc].type && b[nr][nc].player%2 !== p.player%2) m.push({r: nr, c: nc});
            });
        }
        return m;
    }

    isOk(r, c) { return r>=0 && r<16 && c>=0 && c<16 && !this.board[r][c].void; }

    evaluate(b) {
        let sA = 0, sB = 0;
        for(let r=0; r<16; r++) {
            for(let c=0; c<16; c++) {
                let p = b[r][c];
                if(p && p.type) {
                    let v = PIECE_VALS[p.type] + (8 - Math.abs(7.5 - r));
                    if(p.player % 2 === 0) sA += v; else sB += v;
                }
            }
        }
        return sA - sB;
    }

    aiMove() {
        let best = null, bestV = this.turn % 2 === 0 ? -9999 : 9999;
        for(let r=0; r<16; r++) {
            for(let c=0; c<16; c++) {
                if(this.board[r][c].player === this.turn) {
                    this.getMoves(r, c, this.board).forEach(m => {
                        let oldT = {...this.board[m.r][m.c]}, oldM = {...this.board[r][c]};
                        this.board[m.r][m.c] = oldM; this.board[r][c] = {type:null, player:null, void:false};
                        let v = this.evaluate(this.board);
                        if(this.turn % 2 === 0 ? v > bestV : v < bestV) { bestV = v; best = {fr:r, fc:c, tr:m.r, tc:m.c}; }
                        this.board[r][c] = oldM; this.board[m.r][m.c] = oldT;
                    });
                }
            }
        }
        if(best) log(`IA Sugere: (${best.fr},${best.fc}) ‚Üí (${best.tr},${best.tc})`);
    }

    executeMove(fr, fc, tr, tc) {
        const p = this.board[fr][fc];
        const target = this.board[tr][tc];
        if (target.type === 'K') this.kingsAlive[target.player] = false;
        this.board[tr][tc] = { ...p, firstMove: false };
        this.board[fr][fc] = { type: null, player: null, void: false };
        if (p.type === 'P') {
            let promo = (p.player===0 && tr===15) || (p.player===2 && tr===0) || (p.player===3 && tc===15) || (p.player===1 && tc===0);
            if(promo) this.board[tr][tc].type = 'G';
        }
        this.turn = (this.turn + 1) % 4;
        while (!this.kingsAlive[this.turn] && this.kingsAlive.some((k, i) => i % 2 === this.turn % 2 && k)) this.turn = (this.turn + 1) % 4;
        db.update({ board: this.board, turn: this.turn, kingsAlive: this.kingsAlive });
    }
}

/** UI SYNC **/
const engine = new ChaturangaEngine();
let selected = null, validMoves = [];

function draw() {
    const bEl = document.getElementById('board'); bEl.innerHTML = '';
    const score = engine.evaluate(engine.board);
    document.getElementById('bar-a').style.width = `${50 + (score / 150)}%`;
    for(let i=0; i<4; i++) {
        const el = document.getElementById(`p${i}-card`);
        el.className = `stat-card ${engine.turn === i ? 'active-p' : ''}`;
        el.style.opacity = engine.kingsAlive[i] ? '1' : '0.3';
    }
    for(let r=0; r<16; r++) {
        for(let c=0; c<16; c++) {
            const d = engine.board[r][c];
            const div = document.createElement('div');
            div.className = `cell ${(r+c)%2===0?'l':'d'} ${d.void?'void':''} p${d.player}`;
            div.dataset.r = r; div.dataset.c = c;
            if(d.type) div.innerHTML = `<span class="piece">${PIECE_ICONS[d.type]}</span>`;
            if(selected?.r === r && selected?.c === c) div.classList.add('selected');
            const mv = validMoves.find(m => m.r === r && m.c === c);
            if(mv) div.classList.add(engine.board[r][c].type ? 'hint-cap' : 'hint');
            div.onclick = () => {
                const move = validMoves.find(m => m.r === r && m.c === c);
                if(move) { engine.executeMove(selected.r, selected.c, r, c); selected = null; validMoves = []; }
                else if(d.player === engine.turn) { selected = {r, c}; validMoves = engine.getMoves(r, c, engine.board); }
                else { selected = null; validMoves = []; }
                draw();
            };
            bEl.appendChild(div);
        }
    }
}

function log(m) { const l = document.getElementById('log'); l.innerHTML = `<div>> ${m}</div>` + l.innerHTML; }
function resetOnlineGame() { db.set({ board: engine.createBoard(), turn: 0, kingsAlive: [true,true,true,true], chats: { teamA: {}, teamB: {} } }); }

db.on('value', (snap) => {
    const d = snap.val();
    if(d && d.board) { engine.board = d.board; engine.turn = d.turn; engine.kingsAlive = d.kingsAlive; draw(); document.getElementById('log').innerText = "Online"; }
    else resetOnlineGame();
});
</script>
</body>
</html>
