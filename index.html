<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Chaturanga 16x16 - Legion & AI Edition</title>
    <style>
        :root {
            --bg: #020617; --card: #1e293b;
            --tile-l: #cbd5e1; --tile-d: #475569;
            --c0: #f87171; --c1: #4ade80; --c2: #fbbf24; --c3: #60a5fa;
            --cell-size: 5.4vw;
        }
        @media (min-width: 900px) { :root { --cell-size: 38px; } }

        * { box-sizing: border-box; touch-action: manipulation; }
        body { font-family: 'Inter', sans-serif; background: var(--bg); color: white; margin: 0; padding: 10px; display: flex; flex-direction: column; align-items: center; }

        /* Overlay de Sele√ß√£o */
        #player-selector {
            position: fixed; top:0; left:0; width:100%; height:100%; background: rgba(0,0,0,0.95);
            z-index: 1000; display: flex; flex-direction: column; align-items: center; justify-content: center;
        }
        .sel-btn { width: 240px; padding: 15px; margin: 8px; border: none; border-radius: 8px; font-weight: bold; cursor: pointer; color: white; }

        /* Pontua√ß√£o e Clocks */
        .score-container { width: 100%; max-width: 650px; margin-bottom: 10px; }
        .score-labels { display: flex; justify-content: space-between; font-size: 11px; font-weight: bold; margin-bottom: 4px; }
        .score-bar { height: 12px; background: #334155; border-radius: 6px; overflow: hidden; display: flex; border: 1px solid #475569; }
        #bar-a { background: linear-gradient(to right, var(--c0), var(--c2)); width: 50%; transition: 0.8s ease; }
        #bar-b { background: linear-gradient(to right, var(--c1), var(--c3)); width: 50%; transition: 0.8s ease; }

        .players-grid { display: grid; grid-template-columns: repeat(4, 1fr); width: 100%; max-width: 650px; gap: 5px; margin-bottom: 10px; }
        .stat-card { background: var(--card); padding: 8px; border-radius: 4px; border-bottom: 3px solid #444; font-size: 10px; text-align: center; }
        .active-p { border-bottom-color: #fff !important; background: #334155; }
        .clock { font-family: monospace; font-size: 14px; font-weight: bold; margin-top: 3px; }
        .low-time { color: #f87171; animation: blink 1s infinite; }
        @keyframes blink { 50% { opacity: 0.5; } }

        /* Grid Tabuleiro */
        .game-area { display: flex; flex-direction: column; align-items: center; }
        .row-coords { display: grid; grid-template-columns: repeat(16, var(--cell-size)); height: 20px; margin: 0 20px; }
        .middle-row { display: flex; align-items: center; }
        .col-coords { display: grid; grid-template-rows: repeat(16, var(--cell-size)); width: 20px; }
        .label { font-size: 10px; font-weight: 800; color: #64748b; display: flex; align-items: center; justify-content: center; }

        #board { display: grid; grid-template-columns: repeat(16, var(--cell-size)); grid-template-rows: repeat(16, var(--cell-size)); background: #0f172a; border: 2px solid #334155; }
        .cell { width: var(--cell-size); height: var(--cell-size); display: flex; justify-content: center; align-items: center; font-size: calc(var(--cell-size) * 0.7); cursor: pointer; }
        .l { background: var(--tile-l); } .d { background: var(--tile-d); }
        .void { visibility: hidden; pointer-events: none; }
        
        .piece { z-index: 10; user-select: none; transition: 0.1s; }
        .p0 .piece { color: var(--c0); text-shadow: 0 0 8px var(--c0); }
        .p1 .piece { color: var(--c1); text-shadow: 0 0 8px var(--c1); }
        .p2 .piece { color: var(--c2); text-shadow: 0 0 8px var(--c2); }
        .p3 .piece { color: var(--c3); text-shadow: 0 0 8px var(--c3); }
        .selected { background: #94a3b8 !important; box-shadow: inset 0 0 10px black; }
        .ai-hint-square { background: rgba(59, 130, 246, 0.6) !important; box-shadow: inset 0 0 10px #3b82f6; }
        .hint { background: rgba(74, 222, 128, 0.3) !important; border-radius: 50%; background-clip: content-box; padding: 10px; }
        .hint-cap { background: rgba(248, 113, 113, 0.4) !important; }

        /* Sistema de Chat Duplo */
        #chat-container { width: 100%; max-width: 650px; background: var(--card); border-radius: 8px; margin-top: 10px; border: 1px solid #334155; overflow: hidden; }
        .chat-tabs { display: flex; background: #0f172a; border-bottom: 1px solid #334155; }
        .chat-tab { flex: 1; padding: 10px; border: none; background: none; color: #64748b; font-size: 11px; font-weight: bold; cursor: pointer; text-transform: uppercase; }
        .chat-tab.active { color: #fff; background: var(--card); border-bottom: 2px solid #3b82f6; }
        #chat-messages { height: 100px; overflow-y: auto; padding: 10px; font-size: 12px; background: #020617; }
        #chat-input-area { display: flex; padding: 8px; background: var(--card); }
        #chat-input { flex: 1; background: #0f172a; border: 1px solid #334155; color: white; padding: 10px; border-radius: 4px; }

        /* Manual */
        .manual-container { width: 100%; max-width: 650px; background: #111827; border-radius: 8px; padding: 12px; margin-top: 15px; display: grid; grid-template-columns: 1fr 1fr; gap: 10px; border: 1px solid #1e293b; }
        .manual-item { font-size: 10px; line-height: 1.4; color: #94a3b8; }
        .manual-item b { color: #fff; display: block; margin-bottom: 2px; }

        .btn-group { display: flex; gap: 10px; width: 100%; max-width: 650px; margin-top: 15px; }
        .btn { flex: 1; padding: 12px; border-radius: 6px; border: none; font-weight: bold; cursor: pointer; transition: 0.2s; color: white; }
        .btn-ia { background: #3b82f6; }
        .btn-reset { background: #ef4444; }
        #log { font-size: 11px; color: #94a3b8; margin: 10px; text-align: center; }
    </style>
</head>
<body>

    <div id="player-selector">
        <h2 style="margin-bottom: 20px;">Eternal Citadel 16x16</h2>
        <button class="sel-btn" style="background:var(--c0)" onclick="setMyRole(0)">P1: NORTE</button>
        <button class="sel-btn" style="background:var(--c1)" onclick="setMyRole(1)">P2: LESTE</button>
        <button class="sel-btn" style="background:var(--c2)" onclick="setMyRole(2)">P3: SUL</button>
        <button class="sel-btn" style="background:var(--c3)" onclick="setMyRole(3)">P4: OESTE</button>
    </div>

    <div class="score-container">
        <div class="score-labels">
            <span style="color:var(--c0)">TIME A (N/S): <span id="val-a">0</span></span>
            <span style="color:var(--c1)">TIME B (E/W): <span id="val-b">0</span></span>
        </div>
        <div class="score-bar"><div id="bar-a"></div><div id="bar-b"></div></div>
    </div>

    <div class="players-grid">
        <div id="p0-card" class="stat-card">NORTE <div id="clock-0" class="clock">01:00</div></div>
        <div id="p1-card" class="stat-card">LESTE <div id="clock-1" class="clock">01:00</div></div>
        <div id="p2-card" class="stat-card">SUL <div id="clock-2" class="clock">01:00</div></div>
        <div id="p3-card" class="stat-card">OESTE <div id="clock-3" class="clock">01:00</div></div>
    </div>

    <div class="game-area">
        <div class="row-coords" id="coords-top"></div>
        <div class="middle-row">
            <div class="col-coords" id="coords-left"></div>
            <div id="board"></div>
            <div class="col-coords" id="coords-right"></div>
        </div>
        <div class="row-coords" id="coords-bottom"></div>
    </div>

    <div class="btn-group">
        <button class="btn btn-ia" onclick="engine.aiSuggest()">Sugest√£o da IA (Hint)</button>
        <button class="btn btn-reset" onclick="resetOnlineGame()">Reiniciar Jogo</button>
    </div>

    <div id="chat-container">
        <div class="chat-tabs">
            <button id="tab-team" class="chat-tab active" onclick="switchChat('team')">Chat do Time</button>
            <button id="tab-global" class="chat-tab" onclick="switchChat('global')">Chat Global</button>
        </div>
        <div id="chat-messages"></div>
        <div id="chat-input-area">
            <input type="text" id="chat-input" placeholder="Mensagem...">
            <button onclick="sendChatMessage()" style="margin-left:5px; padding:0 15px; background:#3b82f6; border:none; color:white; border-radius:4px; cursor:pointer;">OK</button>
        </div>
    </div>

    <div class="manual-container">
        <div class="manual-item">
            <b>üêâ DRAG√ÉO (D)</b> Cavalo + Desliza 2 casas retas.
            <br><b>‚öîÔ∏è GENERAL (G)</b> Rei + Desliza 2 casas. Promo√ß√£o.
            <br><b>ü¶Ö FALC√ÉO (F)</b> Bispo (Desliza m√°x. 4 casas).
        </div>
        <div class="manual-item">
            <b>üî• F√äNIX (X)</b> Desliza exatamente 2 casas diag.
            <br><b>üêò ELEFANTE (E)</b> Salta 2 casas diag. (Pula pe√ßas).
            <br><b>‚ôüÔ∏è PE√ÉO (P)</b> Avan√ßa 2 no 1¬∫ lance.
        </div>
    </div>

    <div id="log">Status: Sincronizando...</div>

<script src="https://www.gstatic.com/firebasejs/9.1.3/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.1.3/firebase-database-compat.js"></script>

<script>
/** FIREBASE **/
const firebaseConfig = {
    apiKey: "AIzaSyCWE88_PnPfL6QPa9-R9zN6QPQ5Y8Ni_E0",
    authDomain: "chess-4x4.firebaseapp.com",
    databaseURL: "https://chess-4x4-default-rtdb.firebaseio.com",
    projectId: "chess-4x4",
    storageBucket: "chess-4x4.firebasestorage.app",
    messagingSenderId: "735568669929",
    appId: "1:735568669929:web:b5faa11547954fb8051478"
};
firebase.initializeApp(firebaseConfig);
const db = firebase.database().ref("citadel_hint_v21");

let MY_ID = null;
let MY_TEAM = null;
let activeChat = 'team'; 
let clocks = [60, 60, 60, 60];
let clockInterval = null;
let aiSuggestion = null;

function setMyRole(id) {
    MY_ID = id;
    MY_TEAM = (id === 0 || id === 2) ? 'teamA' : 'teamB';
    document.getElementById('player-selector').style.display = 'none';
    initChats();
    drawBoard();
}

/** CHAT **/
function switchChat(type) {
    activeChat = type;
    document.getElementById('tab-team').classList.toggle('active', type === 'team');
    document.getElementById('tab-global').classList.toggle('active', type === 'global');
    document.getElementById('chat-messages').innerHTML = "";
    loadChatHistory();
}
function loadChatHistory() {
    const path = activeChat === 'team' ? `chats/${MY_TEAM}` : 'chats/global';
    db.child(path).off(); 
    db.child(path).limitToLast(15).on('child_added', snap => {
        const d = snap.val();
        const colors = ['var(--c0)','var(--c1)','var(--c2)','var(--c3)'];
        document.getElementById('chat-messages').innerHTML += `<div><b style="color:${colors[d.player]}">P${d.player+1}:</b> ${d.msg}</div>`;
        document.getElementById('chat-messages').scrollTop = 9999;
    });
}
function initChats() { loadChatHistory(); }
function sendChatMessage() {
    const i = document.getElementById('chat-input');
    if(!i.value.trim() || MY_ID === null) return;
    const path = activeChat === 'team' ? `chats/${MY_TEAM}` : 'chats/global';
    db.child(path).push({ player: MY_ID, msg: i.value });
    i.value = "";
}

/** CLOCKS **/
function formatTime(sec) {
    if (sec <= 0) return "00:00";
    return `${Math.floor(sec/60).toString().padStart(2,'0')}:${(sec%60).toString().padStart(2,'0')}`;
}
function updateClocksUI() {
    for(let i=0; i<4; i++) {
        const el = document.getElementById(`clock-${i}`);
        el.innerText = formatTime(clocks[i]);
        el.classList.toggle('low-time', clocks[i] < 10);
    }
}
function startClock() {
    clearInterval(clockInterval);
    clockInterval = setInterval(() => {
        if (clocks[engine.turn] > 0) {
            clocks[engine.turn] -= 1;
            updateClocksUI();
            if (MY_ID === engine.turn && clocks[engine.turn] % 3 === 0) db.child('clocks').set(clocks);
        } else if (MY_ID === engine.turn) {
            engine.passTurnAuto();
        }
    }, 1000);
}

/** ENGINE (16x16) **/
const PIECE_ICONS = { 'R':'‚ôú', 'N':'‚ôû', 'E':'üêò', 'F':'ü¶Ö', 'D':'üêâ', 'X':'üî•', 'G':'‚öîÔ∏è', 'K':'‚ôö', 'P':'‚ôü' };
const PIECE_VALS = { 'P':10, 'N':30, 'E':25, 'F':35, 'D':55, 'X':40, 'G':65, 'R':50, 'K':1000 };

class ChaturangaEngine {
    constructor() { this.dim = 16; this.board = []; this.turn = 0; this.kingsAlive = [true,true,true,true]; }
    
    createBoard() {
        let b = [];
        for(let r=0; r<16; r++) {
            b[r] = [];
            for(let c=0; c<16; c++) b[r][c] = { type: null, player: null, void: (r<3||r>12)&&(c<3||c>12), firstMove: true };
        }
        const layout = ['R','N','E','F','K','G','D','X','N','R'];
        for(let i=0; i<10; i++) {
            this.set(b,0,i+3,layout[i],0); this.set(b,1,i+3,'P',0);
            this.set(b,15,i+3,layout[9-i],2); this.set(b,14,i+3,'P',2);
            this.set(b,i+3,15,layout[i],1); this.set(b,i+3,14,'P',1);
            this.set(b,i+3,0,layout[9-i],3); this.set(b,i+3,1,'P',3);
        }
        return b;
    }
    set(b,r,c,t,p) { if(t) b[r][c] = { type: t, player: p, void: false, firstMove: true }; }

    getMoves(r, c, b) {
        const p = b[r][c]; if(!p || !p.type) return [];
        let m = []; const ds = { ortho:[[0,1],[0,-1],[1,0],[-1,0]], diag:[[1,1],[1,-1],[-1,1],[-1,-1]], knight:[[1,2],[1,-2],[-1,2],[-1,-2],[2,1],[2,-1],[-2,1],[-2,-1]] };
        const slide = (dirs, lim) => dirs.forEach(d => {
            for(let i=1; i<=lim; i++) {
                let nr=r+d[0]*i, nc=c+d[1]*i;
                if(nr<0||nr>=16||nc<0||nc>=16||b[nr][nc].void) break;
                if(!b[nr][nc].type) m.push({r:nr, c:nc});
                else { if(b[nr][nc].player%2 !== p.player%2) m.push({r:nr, c:nc}); break; }
            }
        });
        const jump = (dirs) => dirs.forEach(d => {
            let nr=r+d[0], nc=c+d[1];
            if(nr>=0 && nr<16 && nc>=0 && nc<16 && !b[nr][nc].void) { if(!b[nr][nc].type || b[nr][nc].player%2 !== p.player%2) m.push({r:nr, c:nc}); }
        });
        if(p.type==='R') slide(ds.ortho, 16);
        if(p.type==='N') jump(ds.knight);
        if(p.type==='E') jump([[2,2],[2,-2],[-2,2],[-2,-2]]);
        if(p.type==='F') slide(ds.diag, 4);
        if(p.type==='T') slide(ds.ortho, 2);
        if(p.type==='X') slide(ds.diag, 2);
        if(p.type==='G') slide([...ds.ortho, ...ds.diag], 2);
        if(p.type==='D') { jump(ds.knight); slide(ds.ortho, 2); }
        if(p.type==='K') jump([...ds.ortho, ...ds.diag]);
        if(p.type==='P') {
            let f = [[1,0], [0,-1], [-1,0], [0,1]][p.player];
            if(r+f[0]>=0 && r+f[0]<16 && c+f[1]>=0 && c+f[1]<16 && !b[r+f[0]][c+f[1]].type) {
                m.push({r: r+f[0], c: c+f[1]});
                if(p.firstMove && !b[r+f[0]*2][c+f[1]*2].type) m.push({r: r+f[0]*2, c: c+f[1]*2});
            }
            let caps = p.player%2===0 ? [[f[0],1], [f[0],-1]] : [[1,f[1]], [-1,f[1]]];
            caps.forEach(s => {
                let nr=r+s[0], nc=c+s[1];
                if(nr>=0&&nr<16&&nc>=0&&nc<16 && b[nr][nc].type && b[nr][nc].player%2 !== p.player%2) m.push({r: nr, c: nc});
            });
        }
        return m;
    }

    evaluate(b) {
        let sA=0, sB=0;
        for(let r=0; r<16; r++) for(let c=0; c<16; c++) {
            let p = b[r][c]; if(p.type) { if(p.player%2===0) sA+=PIECE_VALS[p.type]; else sB+=PIECE_VALS[p.type]; }
        }
        return {a:sA, b:sB};
    }

    aiSuggest() {
        if(this.turn !== MY_ID) return;
        let bestMove = null;
        let maxEval = -Infinity;

        for(let r=0; r<16; r++) {
            for(let c=0; c<16; c++) {
                if(this.board[r][c].player === MY_ID) {
                    const moves = this.getMoves(r, c, this.board);
                    moves.forEach(mv => {
                        let score = 0;
                        const target = this.board[mv.r][mv.c];
                        if(target.type) score += PIECE_VALS[target.type] * 10;
                        score += (8 - Math.abs(7.5 - mv.r)) + (8 - Math.abs(7.5 - mv.c));
                        
                        if(score > maxEval) {
                            maxEval = score;
                            bestMove = {from:{r,c}, to:{r:mv.r, c:mv.c}};
                        }
                    });
                }
            }
        }
        if(bestMove) {
            aiSuggestion = bestMove;
            drawBoard();
            
            // NOVO: Enviar mensagem autom√°tica ao Chat Global
            db.child('chats/global').push({ 
                player: MY_ID, 
                msg: "‚ö†Ô∏è ATEN√á√ÉO: ACABEI DE USAR UMA SUGEST√ÉO DA IA! üß†" 
            });

            setTimeout(() => { aiSuggestion = null; drawBoard(); }, 3000);
        }
    }

    passTurnAuto() {
        let n = (this.turn + 1) % 4;
        while(!this.kingsAlive[n] && this.kingsAlive.some((k,i)=>i%2===n%2&&k)) n = (n+1)%4;
        db.update({ turn: n, clocks: clocks });
    }
}

const engine = new ChaturangaEngine();
let selected = null, validMoves = [];

function drawBoard() {
    const letters = "ABCDEFGHIJKLMNOP".split("");
    document.getElementById('coords-top').innerHTML = document.getElementById('coords-bottom').innerHTML = letters.map(l => `<div class="label">${l}</div>`).join("");
    let nums = ""; for(let i=16; i>=1; i--) nums += `<div class="label">${i}</div>`;
    document.getElementById('coords-left').innerHTML = document.getElementById('coords-right').innerHTML = nums;

    const bEl = document.getElementById('board'); bEl.innerHTML = '';
    const sc = engine.evaluate(engine.board);
    document.getElementById('val-a').innerText = sc.a; document.getElementById('val-b').innerText = sc.b;
    document.getElementById('bar-a').style.width = `${(sc.a / (sc.a + sc.b || 1)) * 100}%`;

    for(let i=0; i<4; i++) {
        document.getElementById(`p${i}-card`).className = `stat-card ${engine.turn === i ? 'active-p' : ''}`;
        document.getElementById(`p${i}-card`).style.opacity = engine.kingsAlive[i] ? '1' : '0.3';
    }
    updateClocksUI();

    for(let r=0; r<16; r++) for(let c=0; c<16; c++) {
        const d = engine.board[r][c]; const div = document.createElement('div');
        div.className = `cell ${(r+c)%2===0?'l':'d'} ${d.void?'void':''} p${d.player}`;
        if(d.type) div.innerHTML = `<span class="piece">${PIECE_ICONS[d.type]}</span>`;
        
        if(selected?.r === r && selected?.c === c) div.classList.add('selected');
        
        if(aiSuggestion && ((aiSuggestion.from.r === r && aiSuggestion.from.c === c) || (aiSuggestion.to.r === r && aiSuggestion.to.c === c))) {
            div.classList.add('ai-hint-square');
        }

        const mv = validMoves.find(m => m.r === r && m.c === c);
        if(mv) div.classList.add(engine.board[r][c].type ? 'hint-cap' : 'hint');

        div.onclick = () => {
            if(mv) {
                clocks[MY_ID] += 3;
                if(engine.board[r][c].type === 'K') engine.kingsAlive[engine.board[r][c].player] = false;
                engine.board[r][c] = {...engine.board[selected.r][selected.c], firstMove: false};
                engine.board[selected.r][selected.c] = {type:null, player:null, void:false};
                if(engine.board[r][c].type === 'P' && (r===0||r===15||c===0||c===15)) engine.board[r][c].type = 'G';
                let n = (engine.turn + 1) % 4;
                while(!engine.kingsAlive[n] && engine.kingsAlive.some((k,i)=>i%2===n%2&&k)) n = (n+1)%4;
                db.update({ board: engine.board, turn: n, kingsAlive: engine.kingsAlive, clocks: clocks });
                selected = null; validMoves = [];
            } else if(d.player === engine.turn && MY_ID === engine.turn) {
                selected = {r, c}; validMoves = engine.getMoves(r, c, engine.board);
            } else { selected = null; validMoves = []; }
            drawBoard();
        };
        bEl.appendChild(div);
    }
}

function resetOnlineGame() { 
    if(!confirm("Deseja resetar a partida para todos?")) return;
    db.set({ board: engine.createBoard(), turn: 0, kingsAlive: [true,true,true,true], clocks: [60, 60, 60, 60], chats: {teamA:{}, teamB:{}, global:{}} }); 
}

db.on('value', snap => { 
    const d = snap.val(); 
    if(d && d.board) { 
        engine.board=d.board; engine.turn=d.turn; engine.kingsAlive=d.kingsAlive; clocks = d.clocks || [60,60,60,60];
        startClock(); if(MY_ID !== null) drawBoard(); 
        document.getElementById('log').innerText="Conectado √† Cidadela"; 
    } else {
        db.set({ board: engine.createBoard(), turn: 0, kingsAlive: [true,true,true,true], clocks: [60,60,60,60] });
    }
});
</script>
</body>
</html>
